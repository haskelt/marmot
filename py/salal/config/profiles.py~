import json
import salal.log as log
from . import constants
from . import arguments

#-------------------------------------------------------------------------------

def init ():
    # load the build profiles
    with open(constants.config_root + constants.build_profiles_file) as build_profiles_fh:
        build_profiles = json.load(build_profiles_fh)

    # convert the profile specifier to the correct profile name
    if arguments.profile_specifier == 'default':
        profile = None
        for build_profile in build_profiles:
            if build_profile == 'common':
                continue
            else:
                profile = build_profile
                break
        if profile == None:
            log.message('error', 'Default profile specified, but there are no profiles configured')
    elif arguments.profile_specifier in build_profiles:
        profile = arguments.profile_specifier
    else:
        log.message('error', 'Specified profile does not exist')

    # initialize variables
    variables = dict()
    if 'common' in build_profiles and 'variables' in build_profiles['common']:
        variables.update(build_profiles['common']['variables'])
    if 'variables' in build_profiles[profile]:
        variables.update(build_profiles[profile]['variables'])
    return (profile, variables)
                
#-------------------------------------------------------------------------------

profile, variables = init()
